RULES FOR AUGMENT AGENT — MULTI-TENANT RESTAURANT SaaS (Node.js)

1. MAIN DOMAIN
   - The root domain (yourapp.com) is the marketing + directory site.
   - It lists pricing, features, registered restaurants, and login options.
   - Super Admin console is always hosted at admin.yourapp.com.

2. TENANT SUBDOMAIN CREATION
   - Every restaurant gets a unique subdomain: restaurant-name.yourapp.com
   - Use slugify(name) to generate subdomain; append number if conflict.
   - All restaurant routes resolve under their subdomain.
   - Admin pages for restaurants live under their own subdomain: restaurant-name.yourapp.com/admin

3. SUPER ADMIN ACCESS
   - Super Admin always logs in at admin.yourapp.com
   - Access is restricted to super_admin role with MFA enabled.
   - Super Admin dashboard must display:
     * Active restaurants count
     * Expired subscriptions
     * Subscription plan distribution
     * Revenue trend graphs
     * CRUD operations for restaurants

4. RESTAURANT REGISTRATION FLOW
   When Super Admin registers a restaurant:
   - Validate inputs (name, owner_email, subscription_plan).
   - Generate unique subdomain and create tenant record in database.
   - Create default owner user for the tenant.
   - Create starter menu data and default settings.
   - Trigger provisioning workflow (asynchronous job).

5. PROVISIONING WORKFLOW
   - Step 1: Confirm wildcard DNS (*.yourapp.com) points to load balancer.
   - Step 2: Provision SSL certificate for new subdomain (ACME/Let’s Encrypt).
   - Step 3: Mark tenant as "active" and set subscription start/end dates.
   - Step 4: Send welcome email with login credentials or invite link.
   - Step 5: Log success or failure in audit logs.

6. DATA MODEL RULES
   - Use shared database, shared schema with tenant_id field.
   - All tenant-owned tables (menus, items, orders, users) must include tenant_id.
   - Super Admin queries are cross-tenant; tenant queries are always scoped by tenant_id.

7. ROUTING RULES
   - If host == "admin.yourapp.com", route to Super Admin dashboard.
   - If host == "yourapp.com", route to marketing site.
   - If host == "*.yourapp.com":
       * If path starts with /admin → Restaurant admin dashboard
       * Else → Restaurant public menu site

8. DASHBOARD DATA RULES
   - Active restaurants: count tenants where status='active' and expires_at > NOW()
   - Expired restaurants: count tenants where expires_at < NOW()
   - Subscription distribution: group tenants by plan
   - Revenue trends: sum payments grouped by month
   - All dashboards must include tables with search + filters.

9. ERROR HANDLING
   - If provisioning fails, mark tenant.status='failed' and store error_message.
   - Expose re-provision command for Super Admin.
   - Ensure idempotency: provisioning jobs can run multiple times safely.

10. SECURITY
   - Every query must enforce tenant isolation with tenant_id.
   - Super Admin only accessible from admin.yourapp.com.
   - Enforce MFA for Super Admin accounts.
   - Rate limit by tenant to prevent abuse.

11. BILLING
   - Track subscription plan and renewal dates in tenants table.
   - If expired, mark tenant as inactive and disable their subdomain until renewed.
   - Integrate payments (Stripe/PayPal) for automatic renewals.

12. LOGGING
   - Every tenant provisioning step must be logged with timestamps.
   - Keep audit logs for tenant creation, suspension, and subscription changes.
   - Super Admin can view logs from their dashboard.

END OF RULES
